<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>管理员后台 - 25-10矿大能动</title>
    <link rel="stylesheet" href="css/styles.css">
    <script src=\"js/constants.js\"></script>
    <script src=\"js/utils.js\"></script>
    <script src=\"js/footprint-calculator.js\"></script>
    <script>
        // 管理员页面脚本
        document.addEventListener('DOMContentLoaded', function() {
            const adminLogin = document.getElementById('admin-login');
            const adminDashboard = document.getElementById('admin-dashboard');
            const loginBtn = document.getElementById('admin-login-btn');
            const logoutBtn = document.getElementById('admin-logout');
            const exportBtn = document.getElementById('export-data-btn');
            const loginError = document.getElementById('login-error');
            
            // 简单的管理员验证（实际应用中应该使用后端验证）
            const ADMIN_CREDENTIALS = {
                '王榆腾': '351027',
                'teacher': '251025'
            };
            
            // 检查是否已登录
            const isAdminLoggedIn = sessionStorage.getItem('adminLoggedIn');
            if (isAdminLoggedIn === 'true') {
                showDashboard();
            }
            
            // 登录按钮事件
            loginBtn.addEventListener('click', function() {
                const username = document.getElementById('admin-username').value.trim();
                const password = document.getElementById('admin-password').value;
                
                if (ADMIN_CREDENTIALS[username] === password) {
                    sessionStorage.setItem('adminLoggedIn', 'true');
                    showDashboard();
                } else {
                    loginError.textContent = '用户名或密码错误';
                    loginError.style.display = 'block';
                    setTimeout(() => {
                        loginError.style.display = 'none';
                    }, 3000);
                }
            });
            
            // 退出登录
            logoutBtn.addEventListener('click', function() {
                sessionStorage.removeItem('adminLoggedIn');
                adminDashboard.style.display = 'none';
                adminLogin.style.display = 'block';
            });
            
            // 导出数据
            exportBtn.addEventListener('click', function() {
                exportData();
            });
            
            // 显示仪表盘
            function showDashboard() {
                adminLogin.style.display = 'none';
                adminDashboard.style.display = 'flex';
                loadDashboardData();
            }
            
            // 加载仪表盘数据
            function loadDashboardData() {
                try {
                    // 获取所有用户记录
                    const userRecords = JSON.parse(localStorage.getItem('userRecords') || '[]');
                    const guestRecords = JSON.parse(localStorage.getItem('guestRecords') || '[]');
                    const allRecords = [...userRecords, ...guestRecords];
                    
                    // 按用户分组统计
                    const userStats = {};
                    
                    userRecords.forEach(record => {
                        const id = record.studentId || 'unknown';
                        if (!userStats[id]) {
                            userStats[id] = {
                                studentId: id,
                                userName: record.userName || '未知',
                                totalEmission: 0,
                                totalSavings: 0,
                                recordCount: 0,
                                lastUpdate: record.timestamp
                            };
                        }
                        userStats[id].totalEmission += record.totalEmission || 0;
                        userStats[id].totalSavings += record.savings || 0;
                        userStats[id].recordCount++;
                        if (new Date(record.timestamp) > new Date(userStats[id].lastUpdate)) {
                            userStats[id].lastUpdate = record.timestamp;
                        }
                    });
                    
                    // 添加访客统计
                    if (guestRecords.length > 0) {
                        userStats['guest'] = {
                            studentId: '访客',
                            userName: '访客用户',
                            totalEmission: guestRecords.reduce((sum, r) => sum + (r.totalEmission || 0), 0),
                            totalSavings: guestRecords.reduce((sum, r) => sum + (r.savings || 0), 0),
                            recordCount: guestRecords.length,
                            lastUpdate: guestRecords[guestRecords.length - 1].timestamp
                        };
                    }
                    
                    // 更新统计卡片
                    const totalUsers = Object.keys(userStats).length;
                    const totalRecords = allRecords.length;
                    const totalEmission = allRecords.reduce((sum, r) => sum + (r.totalEmission || 0), 0);
                    const avgEmission = totalRecords > 0 ? totalEmission / totalRecords : 0;
                    
                    document.getElementById('stat-total-users').textContent = totalUsers;
                    document.getElementById('stat-total-records').textContent = totalRecords;
                    document.getElementById('stat-total-emission').textContent = totalEmission.toFixed(2) + ' kg';
                    document.getElementById('stat-average-emission').textContent = avgEmission.toFixed(2) + ' kg';
                    
                    // 显示用户表格
                    displayUserTable(userStats);
                    
                } catch (error) {
                    console.error('加载数据失败:', error);
                }
            }
            
            // 显示用户表格
            function displayUserTable(userStats) {
                const tbody = document.getElementById('users-table-body');
                tbody.innerHTML = '';
                
                // 转换为数组并排序
                const users = Object.values(userStats).sort((a, b) => b.totalEmission - a.totalEmission);
                
                if (users.length === 0) {
                    tbody.innerHTML = '<tr><td colspan=\"5\" style=\"text-align:center;padding:30px;color:#999;\">暂无数据</td></tr>';
                    return;
                }
                
                users.forEach((user, index) => {
                    const row = document.createElement('tr');
                    const date = new Date(user.lastUpdate);
                    const dateStr = date.toLocaleString('zh-CN', {
                        year: 'numeric',
                        month: '2-digit',
                        day: '2-digit',
                        hour: '2-digit',
                        minute: '2-digit'
                    });
                    
                    row.innerHTML = `
                        <td>${index + 1}</td>
                        <td>${user.userName}</td>
                        <td>${user.studentId}</td>
                        <td>${user.totalEmission.toFixed(2)} kg <small style=\"color:#2e7d32;\">(节约${user.totalSavings.toFixed(2)}kg)</small></td>
                        <td>${dateStr}</td>
                    `;
                    tbody.appendChild(row);
                });
            }
            
            // 导出数据为CSV
            function exportData() {
                try {
                    const userRecords = JSON.parse(localStorage.getItem('userRecords') || '[]');
                    const guestRecords = JSON.parse(localStorage.getItem('guestRecords') || '[]');
                    const allRecords = [...userRecords, ...guestRecords];
                    
                    if (allRecords.length === 0) {
                        alert('暂无数据可导出');
                        return;
                    }
                    
                    // 辅助函数：转义CSV字段（处理逗号、引号、换行符）
                    function escapeCSV(value) {
                        if (value === null || value === undefined) return '';
                        const str = String(value);
                        // 如果包含逗号、引号或换行符，需要用双引号包裹，并将引号转义
                        if (str.includes(',') || str.includes('"') || str.includes('\n')) {
                            return '"' + str.replace(/"/g, '""') + '"';
                        }
                        return str;
                    }
                    
                    // CSV表头
                    let csv = '时间,学号,姓名,活动类型,选项1,选项1数量,选项1排放(kg),选项2,选项2数量,选项2排放(kg),总排放(kg),节约量(kg)\n';
                    
                    // CSV数据
                    allRecords.forEach(record => {
                        const date = new Date(record.timestamp).toLocaleString('zh-CN', {
                            year: 'numeric',
                            month: '2-digit',
                            day: '2-digit',
                            hour: '2-digit',
                            minute: '2-digit',
                            second: '2-digit'
                        });
                        
                        const row = [
                            escapeCSV(date),
                            escapeCSV(record.studentId || '访客'),
                            escapeCSV(record.userName || '访客'),
                            escapeCSV(record.activityType === 'transportation' ? '交通' : '食品'),
                            escapeCSV(record.option1Label || ''),
                            escapeCSV(record.option1Amount || 0),
                            escapeCSV(record.option1Emission ? record.option1Emission.toFixed(3) : '0.000'),
                            escapeCSV(record.option2Label || ''),
                            escapeCSV(record.option2Amount || 0),
                            escapeCSV(record.option2Emission ? record.option2Emission.toFixed(3) : '0.000'),
                            escapeCSV(record.totalEmission ? record.totalEmission.toFixed(3) : '0.000'),
                            escapeCSV(record.savings ? record.savings.toFixed(3) : '0.000')
                        ];
                        
                        csv += row.join(',') + '\n';
                    });
                    
                    // 添加UTF-8 BOM头，确保Excel正确识别中文
                    const BOM = '\uFEFF';
                    const csvContent = BOM + csv;
                    
                    // 下载CSV文件
                    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                    const link = document.createElement('a');
                    const url = URL.createObjectURL(blob);
                    link.setAttribute('href', url);
                    link.setAttribute('download', `碳足迹数据_${new Date().toISOString().split('T')[0]}.csv`);
                    link.style.visibility = 'hidden';
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    
                    alert('数据导出成功！');
                } catch (error) {
                    console.error('导出数据失败:', error);
                    alert('导出数据失败: ' + error.message);
                }
            }
        });
    </script>
</head>
<body>
    <header>
        <div class="container">
            <h1>碳足迹计算器</h1>
            <div class="class-info">25-10矿大能动</div>
        </div>
    </header>

    <nav>
        <div class="container">
            <ul>
                <li><a href="index.html">首页</a></li>
                <li><a href="calculator.html">碳足迹计算</a></li>
                <li><a href="records.html">个人记录</a></li>
                <li><a href="ranking.html">班级排名</a></li>
                <li><a href="admin.html" class="active admin-link">管理员登录</a></li>
            </ul>
        </div>
    </nav>

    <main class="container">
        <!-- 管理员登录界面 -->
        <div id="admin-login" class="login-container">
            <h2>管理员登录</h2>
            <div class="form-group">
                <label for="admin-username">用户名</label>
                <input type="text" id="admin-username" required>
            </div>
            <div class="form-group">
                <label for="admin-password">密码</label>
                <input type="password" id="admin-password" required>
            </div>
            <button id="admin-login-btn" class="login-btn">登录</button>
            <div id="login-error" class="login-error" style="display: none;"></div>
            <div style="margin-top: 20px; text-align: center; font-size: 0.9rem; color: #666;">
                <p>注：本页面仅限25-10班管理员和教师使用</p>
            </div>
        </div>

        <!-- 管理员仪表盘 -->
        <div id="admin-dashboard" class="admin-dashboard" style="display: none;">
            <!-- 侧边导航 -->
            <div class="admin-sidebar">
                <h3>管理菜单</h3>
                <ul>
                    <li><a href="#" class="active">数据总览</a></li>
                    <li><a href="#">用户管理</a></li>
                    <li><a href="#">数据导出</a></li>
                    <li><a href="#">系统设置</a></li>
                </ul>
                <button id="admin-logout" class="btn-secondary" style="margin-top: 30px; width: 100%;">注销登录</button>
            </div>

            <!-- 主内容区域 -->
            <div class="admin-content">
                <h2>数据总览</h2>
                
                <!-- 统计卡片 -->
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-number" id="stat-total-users">0</div>
                        <div class="stat-label">总用户数</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="stat-total-records">0</div>
                        <div class="stat-label">总记录数</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="stat-total-emission">0 kg</div>
                        <div class="stat-label">总碳排放量</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="stat-average-emission">0 kg</div>
                        <div class="stat-label">平均碳排放量</div>
                    </div>
                </div>

                <!-- 数据导出 -->
                <div style="margin: 30px 0;">
                    <h3>数据导出</h3>
                    <button id="export-data-btn" class="export-btn">导出班级数据 (CSV)</button>
                    <p style="margin-top: 10px; font-size: 0.9rem; color: #666;">
                        导出的数据包含所有用户的碳足迹记录和统计信息，可用于进一步分析。
                    </p>
                </div>

                <!-- 用户数据表格 -->
                <div>
                    <h3>用户碳足迹数据</h3>
                    <table class="records-table">
                        <thead>
                            <tr>
                                <th>排名</th>
                                <th>姓名</th>
                                <th>学号</th>
                                <th>总碳排放量</th>
                                <th>最后更新时间</th>
                            </tr>
                        </thead>
                        <tbody id="users-table-body">
                            <!-- JavaScript 动态填充 -->
                        </tbody>
                    </table>
                </div>

                <!-- 管理说明 -->
                <div style="margin-top: 40px; padding: 20px; background-color: #f5f5f5; border-radius: 8px;">
                    <h3>管理说明</h3>
                    <ul>
                        <li>本后台仅供25-10班教师和管理员使用，用于数据统计和分析</li>
                        <li>请妥善保管登录凭证，避免泄露</li>
                        <li>导出的数据请按照相关规定妥善保存和使用</li>
                        <li>如有任何问题，请联系系统管理员</li>
                    </ul>
                </div>
            </div>
        </div>
    </main>

    <footer>
        <div class="container">
            <p>© 2023 25-10矿大能动 - 碳足迹计算器</p>
            <p>本网站旨在提高低碳环保意识，为碳减排贡献力量</p>
        </div>
    </footer>
</body>
</html>