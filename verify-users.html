<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>éªŒè¯ç”¨æˆ·æ•°æ® - ç¢³è¶³è¿¹è®¡ç®—å™¨</title>
    <link rel="stylesheet" href="css/styles.css">
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f5f5f5;
            margin: 0;
            padding: 20px;
            line-height: 1.6;
        }
        .container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            padding: 30px;
        }
        h1 {
            color: #2e7d32;
            margin-top: 0;
            text-align: center;
        }
        .status-box {
            padding: 20px;
            border-radius: 6px;
            margin: 20px 0;
            background-color: #f8f9fa;
            border-left: 4px solid #34c759;
        }
        .status-success {
            border-left-color: #34c759;
            background-color: #e8f5e9;
        }
        .status-warning {
            border-left-color: #ff9500;
            background-color: #fff3cd;
        }
        .status-error {
            border-left-color: #ff3b30;
            background-color: #f8d7da;
        }
        .btn {
            background-color: #2e7d32;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 5px;
            transition: background-color 0.3s;
        }
        .btn:hover {
            background-color: #1b5e20;
        }
        .btn-secondary {
            background-color: #757575;
        }
        .btn-secondary:hover {
            background-color: #616161;
        }
        .btn-danger {
            background-color: #ff3b30;
        }
        .btn-danger:hover {
            background-color: #d32f2f;
        }
        .buttons {
            text-align: center;
            margin: 20px 0;
        }
        .metrics {
            display: flex;
            justify-content: space-around;
            flex-wrap: wrap;
            margin: 30px 0;
        }
        .metric-card {
            background-color: #f0f7f1;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            min-width: 150px;
            margin: 10px;
            flex: 1;
            max-width: 250px;
        }
        .metric-value {
            font-size: 32px;
            font-weight: bold;
            color: #2e7d32;
        }
        .metric-label {
            color: #555;
            margin-top: 5px;
        }
        .user-table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
        }
        .user-table th,
        .user-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        .user-table th {
            background-color: #f5f5f5;
            font-weight: bold;
        }
        .user-table tr:hover {
            background-color: #f9f9f9;
        }
        .status-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
        }
        .badge-success {
            background-color: #34c759;
            color: white;
        }
        .badge-warning {
            background-color: #ff9500;
            color: white;
        }
        .badge-error {
            background-color: #ff3b30;
            color: white;
        }
        .logs {
            background-color: #2d2d2d;
            color: #e0e0e0;
            padding: 20px;
            border-radius: 6px;
            margin-top: 30px;
            font-family: 'Courier New', monospace;
            max-height: 300px;
            overflow-y: auto;
            font-size: 14px;
        }
        .log-entry {
            margin: 5px 0;
            padding: 5px 0;
            border-bottom: 1px solid #444;
        }
        .log-success { color: #34c759; }
        .log-error { color: #ff3b30; }
        .log-warning { color: #ff9500; }
        .log-info { color: #34aadc; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ç”¨æˆ·æ•°æ®éªŒè¯é¡µé¢</h1>
        
        <div class="status-box" id="main-status">
            <h2>ğŸ”„ æ­£åœ¨éªŒè¯ç”¨æˆ·æ•°æ®...</h2>
            <p>è¯·ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®å¼€å§‹éªŒè¯æˆ–é‡æ–°å¯¼å…¥ç”¨æˆ·æ•°æ®ã€‚</p>
        </div>
        
        <div class="metrics">
            <div class="metric-card">
                <div class="metric-value" id="total-users">0</div>
                <div class="metric-label">æ€»ç”¨æˆ·æ•°</div>
            </div>
            <div class="metric-card">
                <div class="metric-value" id="imported-users">0</div>
                <div class="metric-label">å·²å¯¼å…¥</div>
            </div>
            <div class="metric-card">
                <div class="metric-value" id="records-count">0</div>
                <div class="metric-label">è®°å½•ç©ºé—´</div>
            </div>
        </div>
        
        <div class="buttons">
            <button id="verifyBtn" class="btn">éªŒè¯ç”¨æˆ·æ•°æ®</button>
            <button id="reimportBtn" class="btn btn-secondary">é‡æ–°å¯¼å…¥ç”¨æˆ·</button>
            <button id="clearBtn" class="btn btn-danger">æ¸…ç©ºæ‰€æœ‰ç”¨æˆ·</button>
        </div>
        
        <h3>ç”¨æˆ·åˆ—è¡¨</h3>
        <table class="user-table">
            <thead>
                <tr>
                    <th>å§“å</th>
                    <th>å­¦å·</th>
                    <th>çŠ¶æ€</th>
                    <th>è®°å½•ç©ºé—´</th>
                </tr>
            </thead>
            <tbody id="user-list">
                <!-- ç”¨æˆ·åˆ—è¡¨å°†åŠ¨æ€ç”Ÿæˆ -->
            </tbody>
        </table>
        
        <h3>éªŒè¯æ—¥å¿—</h3>
        <div class="logs" id="logs">
            <!-- æ—¥å¿—å°†åŠ¨æ€ç”Ÿæˆ -->
        </div>
    </div>

    <script>
        // ç¡®ä¿STORAGE_KEYSå­˜åœ¨
        if (!window.STORAGE_KEYS) {
            window.STORAGE_KEYS = {
                USER_RECORDS: 'carbon_footprint_records',
                USER_INFO: 'user_info',
                CLASS_RANKING: 'class_carbon_ranking',
                ADMIN_LOGGED_IN: 'admin_logged_in',
                USER_LOGGED_IN: 'user_logged_in'
            };
        }

        // é¢„æœŸçš„å­¦ç”Ÿåˆ—è¡¨
        const expectedStudents = [
            { name: "èƒ¡æ˜Šæ¨", studentId: "17252404" },
            { name: "å†’éˆºåŸ", studentId: "17250514" },
            { name: "åˆ˜é’Šæº", studentId: "17250082" },
            { name: "åˆ˜å½¦é’Š", studentId: "17253321" },
            { name: "å¼ æ™¨", studentId: "17253334" },
            { name: "é‡‘æ‰¬é¢–", studentId: "15245793" },
            { name: "å¼ å®‡æ¬£", studentId: "17255887" },
            { name: "å•å½¦åš", studentId: "17251502" },
            { name: "è°¢æµ©ç„¶", studentId: "17251546" },
            { name: "å¤é›¨ç’¨", studentId: "17251531" },
            { name: "å®ä½³ä½³", studentId: "17255417" },
            { name: "èµµé›…æ˜Ÿ", studentId: "17255893" },
            { name: "å”äºæ°", studentId: "17253344" },
            { name: "ä½•å‰‘é£", studentId: "17253299" },
            { name: "å‘¨å®‡ç¿”", studentId: "17254248" }
        ];

        // æ—¥å¿—å‡½æ•°
        function addLog(message, type = 'info') {
            const logsDiv = document.getElementById('logs');
            const logClass = {
                'success': 'log-success',
                'error': 'log-error',
                'warning': 'log-warning',
                'info': 'log-info'
            }[type] || 'log-info';
            
            const now = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry ${logClass}`;
            logEntry.textContent = `[${now}] ${message}`;
            logsDiv.appendChild(logEntry);
            logsDiv.scrollTop = logsDiv.scrollHeight;
        }

        // éªŒè¯ç”¨æˆ·æ•°æ®
        function verifyUserData() {
            addLog('å¼€å§‹éªŒè¯ç”¨æˆ·æ•°æ®...', 'info');
            
            try {
                // è·å–å„ç§å­˜å‚¨ä½ç½®çš„ç”¨æˆ·æ•°æ®
                const allUsers = JSON.parse(localStorage.getItem('allUsers') || '[]');
                const classUsers = JSON.parse(localStorage.getItem('classUsers') || '[]');
                const rankingData = JSON.parse(localStorage.getItem(window.STORAGE_KEYS.CLASS_RANKING) || '{}');
                
                addLog(`å‘ç° allUsers ä¸­æœ‰ ${allUsers.length} ä¸ªç”¨æˆ·`, 'info');
                addLog(`å‘ç° classUsers ä¸­æœ‰ ${classUsers.length} ä¸ªç”¨æˆ·`, 'info');
                addLog(`å‘ç°æ’åæ•°æ®ä¸­æœ‰ ${Object.keys(rankingData).length} ä¸ªç”¨æˆ·è®°å½•`, 'info');
                
                // éªŒè¯é¢„æœŸçš„å­¦ç”Ÿæ˜¯å¦å­˜åœ¨
                let foundCount = 0;
                const userList = document.getElementById('user-list');
                userList.innerHTML = '';
                
                expectedStudents.forEach(student => {
                    // æ£€æŸ¥å¤šç§å­˜å‚¨ä½ç½®
                    const existsInAllUsers = allUsers.some(u => u.studentId === student.studentId);
                    const existsInClassUsers = classUsers.some(u => u.studentId === student.studentId);
                    const existsInRanking = rankingData[student.studentId] !== undefined;
                    const userRecordKey = `${window.STORAGE_KEYS.USER_RECORDS}_${student.studentId}`;
                    const hasUserRecord = localStorage.getItem(userRecordKey) !== null;
                    const hasUserInfo = localStorage.getItem(`${window.STORAGE_KEYS.USER_INFO}_${student.studentId}`) !== null;
                    
                    // åªè¦åœ¨ä»»ä¸€å­˜å‚¨ä½ç½®å­˜åœ¨å°±è®¤ä¸ºå·²å¯¼å…¥
                    const isImported = existsInAllUsers || existsInClassUsers || existsInRanking || hasUserRecord || hasUserInfo;
                    
                    if (isImported) {
                        foundCount++;
                    }
                    
                    // åˆ›å»ºè¡¨æ ¼è¡Œ
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${student.name}</td>
                        <td>${student.studentId}</td>
                        <td><span class="status-badge ${isImported ? 'badge-success' : 'badge-error'}">${isImported ? 'å·²å¯¼å…¥' : 'æœªå¯¼å…¥'}</span></td>
                        <td><span class="status-badge ${hasUserRecord ? 'badge-success' : 'badge-warning'}">${hasUserRecord ? 'å·²åˆ›å»º' : 'æœªåˆ›å»º'}</span></td>
                    `;
                    userList.appendChild(row);
                });
                
                // æ›´æ–°ç»Ÿè®¡æ•°æ®
                document.getElementById('total-users').textContent = expectedStudents.length;
                document.getElementById('imported-users').textContent = foundCount;
                
                // ç»Ÿè®¡è®°å½•ç©ºé—´æ•°é‡
                let recordCount = 0;
                expectedStudents.forEach(student => {
                    const userRecordKey = `${window.STORAGE_KEYS.USER_RECORDS}_${student.studentId}`;
                    if (localStorage.getItem(userRecordKey) !== null) {
                        recordCount++;
                    }
                });
                document.getElementById('records-count').textContent = recordCount;
                
                // æ›´æ–°ä¸»çŠ¶æ€
                const mainStatus = document.getElementById('main-status');
                if (foundCount === expectedStudents.length) {
                    mainStatus.className = 'status-box status-success';
                    mainStatus.innerHTML = `
                        <h2>âœ… éªŒè¯æˆåŠŸï¼</h2>
                        <p>æ‰€æœ‰ ${expectedStudents.length} åç”¨æˆ·éƒ½å·²æˆåŠŸå¯¼å…¥ç³»ç»Ÿã€‚</p>
                    `;
                    addLog('âœ… æ‰€æœ‰ç”¨æˆ·éƒ½å·²æˆåŠŸå¯¼å…¥ï¼', 'success');
                } else if (foundCount > 0) {
                    mainStatus.className = 'status-box status-warning';
                    mainStatus.innerHTML = `
                        <h2>âš ï¸ éƒ¨åˆ†å¯¼å…¥</h2>
                        <p>æˆåŠŸå¯¼å…¥äº† ${foundCount}/${expectedStudents.length} åç”¨æˆ·ï¼Œè¯·ç‚¹å‡»"é‡æ–°å¯¼å…¥ç”¨æˆ·"æŒ‰é’®ã€‚</p>
                    `;
                    addLog(`âš ï¸ éƒ¨åˆ†å¯¼å…¥: ${foundCount}/${expectedStudents.length} åç”¨æˆ·`, 'warning');
                } else {
                    mainStatus.className = 'status-box status-error';
                    mainStatus.innerHTML = `
                        <h2>âŒ æœªå¯¼å…¥</h2>
                        <p>æ²¡æœ‰å‘ç°ä»»ä½•ç”¨æˆ·æ•°æ®ï¼Œè¯·ç‚¹å‡»"é‡æ–°å¯¼å…¥ç”¨æˆ·"æŒ‰é’®ã€‚</p>
                    `;
                    addLog('âŒ æœªå‘ç°ä»»ä½•ç”¨æˆ·æ•°æ®', 'error');
                }
                
            } catch (error) {
                addLog(`éªŒè¯è¿‡ç¨‹å‡ºé”™: ${error.message}`, 'error');
                const mainStatus = document.getElementById('main-status');
                mainStatus.className = 'status-box status-error';
                mainStatus.innerHTML = `
                    <h2>âŒ éªŒè¯å‡ºé”™</h2>
                    <p>éªŒè¯è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯ï¼š${error.message}</p>
                `;
            }
        }

        // é‡æ–°å¯¼å…¥ç”¨æˆ·æ•°æ®
        function reimportUsers() {
            addLog('å¼€å§‹é‡æ–°å¯¼å…¥ç”¨æˆ·æ•°æ®...', 'info');
            
            try {
                // ä¸ºæ¯ä¸ªå­¦ç”Ÿåˆ›å»ºæˆ–æ›´æ–°è®°å½•
                let addedCount = 0;
                
                expectedStudents.forEach(student => {
                    // æ£€æŸ¥æ˜¯å¦éœ€è¦æ·»åŠ 
                    const userRecordKey = `${window.STORAGE_KEYS.USER_RECORDS}_${student.studentId}`;
                    const hasExistingRecord = localStorage.getItem(userRecordKey) !== null;
                    
                    // ä¸ºç”¨æˆ·åˆ›å»ºè®°å½•å­˜å‚¨ç©ºé—´ï¼ˆæ€»æ˜¯æ›´æ–°ï¼Œç¡®ä¿å­˜åœ¨ï¼‰
                    localStorage.setItem(userRecordKey, JSON.stringify([]));
                    
                    // ä¸ºç”¨æˆ·åˆ›å»ºå•ç‹¬çš„ä¿¡æ¯å­˜å‚¨
                    localStorage.setItem(`${window.STORAGE_KEYS.USER_INFO}_${student.studentId}`, JSON.stringify({
                        name: student.name,
                        studentId: student.studentId
                    }));
                    
                    if (!hasExistingRecord) {
                        addedCount++;
                    }
                    
                    addLog(`âœ… å¤„ç†ç”¨æˆ·: ${student.name} (${student.studentId})`, 'success');
                });
                
                // æ›´æ–°å…¨å±€ç”¨æˆ·åˆ—è¡¨
                const allUsers = expectedStudents.map(student => ({
                    name: student.name,
                    studentId: student.studentId,
                    createdAt: new Date().toISOString()
                }));
                localStorage.setItem('allUsers', JSON.stringify(allUsers));
                
                // æ›´æ–°ç­çº§ç”¨æˆ·åˆ—è¡¨
                const classUsers = expectedStudents.map(student => ({
                    name: student.name,
                    studentId: student.studentId
                }));
                localStorage.setItem('classUsers', JSON.stringify(classUsers));
                
                // æ›´æ–°æ’åæ•°æ®
                const rankingData = {};
                expectedStudents.forEach(student => {
                    rankingData[student.studentId] = {
                        name: student.name,
                        studentId: student.studentId,
                        totalEmission: 0,
                        totalSavings: 0,
                        recordCount: 0,
                        lastUpdated: new Date().toISOString()
                    };
                });
                localStorage.setItem(window.STORAGE_KEYS.CLASS_RANKING, JSON.stringify(rankingData));
                
                addLog(`âœ… æˆåŠŸå¯¼å…¥/æ›´æ–° ${expectedStudents.length} ä¸ªç”¨æˆ·ï¼`, 'success');
                addLog(`æ–°å¢: ${addedCount} ä¸ªç”¨æˆ·ï¼Œæ›´æ–°: ${expectedStudents.length - addedCount} ä¸ªç”¨æˆ·`, 'info');
                
                // é‡æ–°éªŒè¯
                verifyUserData();
                
            } catch (error) {
                addLog(`å¯¼å…¥è¿‡ç¨‹å‡ºé”™: ${error.message}`, 'error');
            }
        }

        // æ¸…ç©ºæ‰€æœ‰ç”¨æˆ·æ•°æ®
        function clearUserData() {
            if (confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰ç”¨æˆ·æ•°æ®å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼')) {
                addLog('å¼€å§‹æ¸…ç©ºç”¨æˆ·æ•°æ®...', 'warning');
                
                try {
                    // æ¸…é™¤æ‰€æœ‰ç›¸å…³çš„å­˜å‚¨æ•°æ®
                    localStorage.removeItem('allUsers');
                    localStorage.removeItem('classUsers');
                    localStorage.removeItem(window.STORAGE_KEYS.CLASS_RANKING);
                    
                    // æ¸…é™¤æ¯ä¸ªç”¨æˆ·çš„è®°å½•
                    expectedStudents.forEach(student => {
                        const userRecordKey = `${window.STORAGE_KEYS.USER_RECORDS}_${student.studentId}`;
                        const userInfoKey = `${window.STORAGE_KEYS.USER_INFO}_${student.studentId}`;
                        localStorage.removeItem(userRecordKey);
                        localStorage.removeItem(userInfoKey);
                    });
                    
                    addLog('âœ… æ‰€æœ‰ç”¨æˆ·æ•°æ®å·²æ¸…ç©ºï¼', 'success');
                    
                    // é‡æ–°éªŒè¯
                    verifyUserData();
                    
                } catch (error) {
                    addLog(`æ¸…ç©ºæ•°æ®å¤±è´¥: ${error.message}`, 'error');
                }
            }
        }

        // äº‹ä»¶ç›‘å¬
        document.getElementById('verifyBtn').addEventListener('click', verifyUserData);
        document.getElementById('reimportBtn').addEventListener('click', reimportUsers);
        document.getElementById('clearBtn').addEventListener('click', clearUserData);
        
        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨éªŒè¯
        window.addEventListener('load', function() {
            setTimeout(verifyUserData, 1000); // å»¶è¿Ÿ1ç§’æ‰§è¡Œï¼Œç¡®ä¿main.jsä¸­çš„è‡ªåŠ¨å¯¼å…¥å…ˆæ‰§è¡Œ
        });
    </script>
</body>
</html>