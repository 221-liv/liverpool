<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç­çº§æ’å - 25-10çŸ¿å¤§èƒ½åŠ¨</title>
    <link rel="stylesheet" href="css/styles.css">
    <script src="js/constants.js"></script>
    <script src="js/utils.js"></script>
    <script src="js/footprint-calculator.js"></script>
    <script src="js/main.js" defer></script>
    <script>
        // æ£€æŸ¥ç™»å½•çŠ¶æ€
        document.addEventListener('DOMContentLoaded', function() {
            // æ£€æŸ¥æœ¬åœ°å­˜å‚¨ä¸­æ˜¯å¦æœ‰STORAGE_KEYSå¯¹è±¡
            if (!window.STORAGE_KEYS) {
                window.STORAGE_KEYS = {
                    USER_INFO: 'userInfo',
                    USER_RECORDS: 'userRecords',
                    CLASS_RANKING: 'classRanking'
                };
            }
            
            // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å·²ç™»å½•
            let userInfo = null;
            try {
                if (window.utils && window.utils.storage && typeof window.utils.storage.get === 'function') {
                    userInfo = window.utils.storage.get(STORAGE_KEYS.USER_INFO);
                } else {
                    const storedInfo = localStorage.getItem(STORAGE_KEYS.USER_INFO);
                    if (storedInfo) {
                        userInfo = JSON.parse(storedInfo);
                    }
                }
            } catch (error) {
                console.error('è·å–ç”¨æˆ·ä¿¡æ¯å¤±è´¥:', error);
            }
            
            // å¦‚æœæœªç™»å½•ï¼Œè·³è½¬åˆ°ç™»å½•é¡µé¢
            if (!userInfo) {
                window.location.href = 'login.html';
            }
            
            // åŠ è½½æ’åæ•°æ®
            loadRankingData();
        });
        
        // åŠ è½½å¹¶æ˜¾ç¤ºæ’åæ•°æ®
        function loadRankingData() {
            try {
                // è·å–ç”¨æˆ·è®°å½•
                let userRecords = JSON.parse(localStorage.getItem('userRecords') || '[]');
                
                // å¦‚æœæ²¡æœ‰è®°å½•ï¼Œä½¿ç”¨é»˜è®¤çš„18åå­¦ç”Ÿæ•°æ®
                if (userRecords.length === 0) {
                    // 18åå­¦ç”Ÿçš„å®Œæ•´æ•°æ®
                    const defaultStudentList = [
                        { studentId: '17252404', userName: 'èƒ¡æ˜Šæ¨', option1Emission: 3.33, option2Emission: 0, savings: 3.33 },
                        { studentId: '17250514', userName: 'å†’éˆºåŸ', option1Emission: 2.06, option2Emission: 0, savings: 2.06 },
                        { studentId: '17250082', userName: 'åˆ˜é’Šæº', option1Emission: 4.69, option2Emission: 4.8, savings: 0.11 },
                        { studentId: '17253321', userName: 'åˆ˜å½¦é’Š', option1Emission: 4.16, option2Emission: 0, savings: 4.16 },
                        { studentId: '17253334', userName: 'å¼ æ™¨', option1Emission: 4.16, option2Emission: 0, savings: 4.16 },
                        { studentId: '15245793', userName: 'é‡‘æ‰¬é¢–', option1Emission: 0, option2Emission: 135, savings: 135 },
                        { studentId: '17255887', userName: 'å¼ å®‡æ¬£', option1Emission: 4.894, option2Emission: 0, savings: 4.894 },
                        { studentId: '17251502', userName: 'å•å½¦åš', option1Emission: 4.894, option2Emission: 0, savings: 4.894 },
                        { studentId: '17251546', userName: 'è°¢æµ©ç„¶', option1Emission: 3.274, option2Emission: 0, savings: 3.274 },
                        { studentId: '17251531', userName: 'å¤é›¨ç’¨', option1Emission: 2.062, option2Emission: 0, savings: 2.062 },
                        { studentId: '17255417', userName: 'å®ä½³ä½³', option1Emission: 3.66, option2Emission: 0, savings: 3.66 },
                        { studentId: '17255893', userName: 'èµµé›…æ˜Ÿ', option1Emission: 2.54, option2Emission: 0, savings: 2.54 },
                        { studentId: '17253344', userName: 'å”äºæ°', option1Emission: 3.75, option2Emission: 0.6, savings: 3.15 },
                        { studentId: '17253299', userName: 'ä½•å‰‘é£', option1Emission: 3.72, option2Emission: 0, savings: 3.72 },
                        { studentId: '17254248', userName: 'å‘¨å®‡ç¿”', option1Emission: 3.41, option2Emission: 0, savings: 3.41 },
                        { studentId: '17252415', userName: 'ç‹å˜‰æ‡¿', option1Emission: 3.35, option2Emission: 0, savings: 3.35 },
                        { studentId: '17254593', userName: 'ç‹å®¶è±ª', option1Emission: 2.41, option2Emission: 0, savings: 2.41 },
                        { studentId: '17250525', userName: 'å¼ æ›¼æ­†', option1Emission: 2.894, option2Emission: 13.09, savings: 15.974 }
                    ];
                    
                    // ä¸ºæ¯ä¸ªå­¦ç”Ÿåˆ›å»ºè®°å½•
                    userRecords = [];
                    defaultStudentList.forEach(student => {
                        // ä¸ºæ¯ä¸ªå­¦ç”Ÿåˆ›å»º2-3æ¡è®°å½•
                        const recordCount = Math.floor(Math.random() * 2) + 2;
                        for (let i = 0; i < recordCount; i++) {
                            const now = new Date();
                            const recordDate = new Date(now.getTime() - i * 24 * 60 * 60 * 1000);
                            
                            userRecords.push({
                                studentId: student.studentId,
                                userName: student.userName,
                                activityType: i % 2 === 0 ? 'äº¤é€šå‡ºè¡Œ' : 'é¥®é£Ÿæ¶ˆè´¹',
                                option1: 'æ­¥è¡Œ',
                                option1Count: 1,
                                option1Emission: student.option1Emission.toString(),
                                option2: 'é£Ÿå“æ¶ˆè´¹',
                                option2Count: student.option2Emission > 0 ? 1 : 0,
                                option2Emission: student.option2Emission,
                                totalEmission: student.option1Emission + student.option2Emission,
                                savings: student.savings,
                                timestamp: recordDate.toISOString()
                            });
                        }
                    });
                    
                    // ä¿å­˜åˆ°localStorage
                    localStorage.setItem('userRecords', JSON.stringify(userRecords));
                }
                
                // æŒ‰å­¦ç”ŸIDåˆ†ç»„å¹¶è®¡ç®—ç´¯è®¡æ’æ”¾
                const studentEmissions = {};
                
                userRecords.forEach(record => {
                    if (!studentEmissions[record.studentId]) {
                        studentEmissions[record.studentId] = {
                            studentId: record.studentId,
                            userName: record.userName,
                            totalEmission: 0,
                            totalSavings: 0,
                            recordCount: 0
                        };
                    }
                    
                    // å°†option1Emissionè½¬æ¢ä¸ºæ•°å­—ç±»å‹
                    const option1Emission = parseFloat(record.option1Emission);
                    
                    studentEmissions[record.studentId].totalEmission += option1Emission + record.option2Emission;
                    studentEmissions[record.studentId].totalSavings += record.savings;
                    studentEmissions[record.studentId].recordCount += 1;
                });
                
                // è½¬æ¢ä¸ºæ•°ç»„å¹¶æŒ‰æ€»æ’æ”¾é‡æ’åºï¼ˆå‡åºï¼‰
                const rankingArray = Object.values(studentEmissions)
                    .sort((a, b) => a.totalEmission - b.totalEmission);
                
                // æ›´æ–°ç­çº§ç»Ÿè®¡ä¿¡æ¯
                const classSize = rankingArray.length;
                const classAverage = classSize > 0 ? 
                    rankingArray.reduce((sum, item) => sum + item.totalEmission, 0) / classSize : 0;
                
                document.getElementById('class-stats-size').textContent = classSize;
                document.getElementById('class-stats-average').textContent = classAverage.toFixed(2) + ' kg';
                
                // æ˜¾ç¤ºæ’ååˆ—è¡¨
                const rankingList = document.getElementById('ranking-list');
                rankingList.innerHTML = '';
                
                rankingArray.forEach((student, index) => {
                    const rankItem = document.createElement('div');
                    rankItem.className = 'ranking-item';
                    
                    // æ’åå›¾æ ‡
                    let rankIcon = 'ğŸ…';
                    if (index === 0) rankIcon = 'ğŸ¥‡';
                    else if (index === 1) rankIcon = 'ğŸ¥ˆ';
                    else if (index === 2) rankIcon = 'ğŸ¥‰';
                    
                    rankItem.innerHTML = `
                        <div class="ranking-rank">${index + 1} ${rankIcon}</div>
                        <div class="ranking-student">
                            <div class="student-name">${student.userName}</div>
                            <div class="student-id">${student.studentId}</div>
                        </div>
                        <div class="ranking-emission">${student.totalEmission.toFixed(2)} kg</div>
                        <div class="ranking-savings">${student.totalSavings.toFixed(2)} kg</div>
                        <div class="ranking-records">${student.recordCount} æ¡</div>
                    `;
                    
                    rankingList.appendChild(rankItem);
                });
                
                console.log('âœ… æ’åæ•°æ®åŠ è½½å®Œæˆ');
            } catch (error) {
                console.error('âŒ åŠ è½½æ’åæ•°æ®å¤±è´¥:', error);
            }
            
            // æ›´æ–°å¯¼èˆªæ 
            const registerLink = document.getElementById('register-link');
            const logoutButton = document.getElementById('logout-button');
            
            if (userInfo) {
                // å·²ç™»å½•çŠ¶æ€
                if (registerLink) registerLink.style.display = 'none';
                if (logoutButton) logoutButton.style.display = 'block';
                
                // æ·»åŠ é€€å‡ºç™»å½•äº‹ä»¶
                if (logoutButton) {
                    logoutButton.addEventListener('click', function(e) {
                        e.preventDefault();
                        try {
                            if (window.utils && window.utils.storage && typeof window.utils.storage.remove === 'function') {
                                window.utils.storage.remove(STORAGE_KEYS.USER_INFO);
                            } else {
                                localStorage.removeItem(STORAGE_KEYS.USER_INFO);
                            }
                            window.location.href = 'login.html';
                        } catch (error) {
                            console.error('é€€å‡ºç™»å½•å¤±è´¥:', error);
                        }
                    });
                }
            }
        });
    </script>
</head>
<body>
    <header>
        <div class="container">
            <h1>ç¢³è¶³è¿¹è®¡ç®—å™¨</h1>
            <div class="class-info">25-10çŸ¿å¤§èƒ½åŠ¨</div>
        </div>
    </header>

    <nav>
        <div class="container">
            <ul>
                <li><a href="index.html">é¦–é¡µ</a></li>
                <li><a href="calculator.html">ç¢³è¶³è¿¹è®¡ç®—</a></li>
                <li><a href="records.html">ä¸ªäººè®°å½•</a></li>
                <li><a href="ranking.html" class="active">ç­çº§æ’å</a></li>
                <li><a href="login.html" id="register-link">ç™»å½•</a></li>
                <li><a href="#" id="logout-button" style="display:none;">é€€å‡ºç™»å½•</a></li>
                <li><a href="admin.html" class="admin-link">ç®¡ç†å‘˜ç™»å½•</a></li>
            </ul>
        </div>
    </nav>

    <main class="container">
        <h2>ç­çº§ç¢³è¶³è¿¹æ’å</h2>
        <p>æŸ¥çœ‹ç­çº§åŒå­¦çš„ç¢³è¶³è¿¹æ’åæƒ…å†µï¼Œå…±åŒè¿›æ­¥ï¼Œå…±å»ºä½ç¢³ç­çº§</p>
        
        <!-- ç­çº§ç»Ÿè®¡ä¿¡æ¯ -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-number" id="class-stats-size">0</div>
                <div class="stat-label">ç­çº§äººæ•°</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="class-stats-average">0 kg</div>
                <div class="stat-label">ç­çº§å¹³å‡æ’æ”¾</div>
            </div>
        </div>
        
        <!-- æ’ååˆ—è¡¨ -->
        <div class="ranking-container">
            <h3>ç¢³è¶³è¿¹æ’è¡Œæ¦œ</h3>
            <p>æ³¨ï¼šæ’ååŸºäºç´¯è®¡ç¢³è¶³è¿¹æ€»é‡ï¼Œæ•°å€¼è¶Šä½æ’åè¶Šé å‰</p>
            <div id="ranking-list">
                <!-- JavaScript åŠ¨æ€å¡«å…… -->
            </div>
        </div>
        
        <!-- ç¯ä¿å€¡è®® -->
        <div class="calculator-card" style="margin-top: 30px;">
            <h3>ç­çº§ç¯ä¿å€¡è®®</h3>
            <p>ä½œä¸ºçŸ¿ä¸šå¤§å­¦ä½ç¢³èƒ½æºåŠ¨åŠ›å·¥ç¨‹ä¸“ä¸šçš„å­¦ç”Ÿï¼Œæˆ‘ä»¬è‚©è´Ÿç€æ¨åŠ¨ä½ç¢³å‘å±•çš„ä½¿å‘½ã€‚è®©æˆ‘ä»¬ï¼š</p>
            <ul>
                <li>ç§¯æå‚ä¸ç¢³è¶³è¿¹è®¡ç®—ï¼Œäº†è§£è‡ªå·±çš„ç¯å¢ƒå½±å“</li>
                <li>ç›¸äº’å­¦ä¹ ï¼Œåˆ†äº«ä½ç¢³ç”Ÿæ´»æŠ€å·§å’Œç»éªŒ</li>
                <li>åœ¨æ—¥å¸¸ç”Ÿæ´»ä¸­è·µè¡Œä½ç¢³ç†å¿µï¼Œä»ç‚¹æ»´åšèµ·</li>
                <li>å‘æŒ¥ä¸“ä¸šä¼˜åŠ¿ï¼Œä¸ºç¢³å‡æ’æŠ€æœ¯åˆ›æ–°è´¡çŒ®åŠ›é‡</li>
            </ul>
            <p>é€šè¿‡ç­çº§æ’åï¼Œæˆ‘ä»¬æ—¨åœ¨æ¿€åŠ±å¤§å®¶å…±åŒè¿›æ­¥ï¼Œè€Œä¸æ˜¯ç®€å•çš„ç«äº‰ã€‚è®©æˆ‘ä»¬ä¸€èµ·åŠªåŠ›ï¼Œæˆä¸ºä½ç¢³ç”Ÿæ´»çš„å…ˆè¡Œè€…ï¼</p>
        </div>
    </main>

    <footer>
        <div class="container">
            <p>Â© 2023 25-10çŸ¿å¤§èƒ½åŠ¨ - ç¢³è¶³è¿¹è®¡ç®—å™¨</p>
            <p>æœ¬ç½‘ç«™æ—¨åœ¨æé«˜ä½ç¢³ç¯ä¿æ„è¯†ï¼Œä¸ºç¢³å‡æ’è´¡çŒ®åŠ›é‡</p>
        </div>
    </footer>
</body>
</html>