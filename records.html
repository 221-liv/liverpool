<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¸ªäººè®°å½• - 25-10çŸ¿å¤§èƒ½åŠ¨</title>
    <link rel="stylesheet" href="css/styles.css">
    <script src="js/auth.js"></script>
    <script src="js/constants.js"></script>
    <script src="js/utils.js"></script>
    <script src="js/footprint-calculator.js"></script>
    <script src="js/main.js" defer></script>
    <script>
        // ä¸ªäººè®°å½•é¡µé¢ - ä½¿ç”¨ç»Ÿä¸€çš„AuthManagerå’ŒRecordManager
        document.addEventListener('DOMContentLoaded', function() {
            console.log('ä¸ªäººè®°å½•é¡µé¢åˆå§‹åŒ–');
            
            // è·å–å½“å‰ç”¨æˆ·ä¿¡æ¯
            const userInfo = window.AuthManager ? window.AuthManager.getCurrentUser() : null;
            
            // æ›´æ–°é¡µé¢æ ‡é¢˜å’Œæç¤º
            const pageTitle = document.querySelector('main h2');
            if (userInfo) {
                pageTitle.textContent = `${userInfo.name}çš„ç¢³è¶³è¿¹è®°å½•`;
                console.log('âœ… ç”¨æˆ·æ¨¡å¼:', userInfo.name);
            } else {
                pageTitle.textContent = 'ä¸ªäººç¢³è¶³è¿¹è®°å½•ï¼ˆè®¿å®¢æ¨¡å¼ï¼‰';
                console.log('â„¹ï¸ è®¿å®¢æ¨¡å¼');
                
                // æ·»åŠ ç™»å½•æç¤º
                const loginTip = document.createElement('div');
                loginTip.className = 'info-message';
                loginTip.style.cssText = 'background:#e3f2fd;padding:15px;border-radius:8px;margin-bottom:20px;color:#1976d2;border-left:4px solid #1976d2;';
                loginTip.innerHTML = '<strong>ğŸ’¡ æç¤ºï¼š</strong>æ‚¨å½“å‰ä½¿ç”¨è®¿å®¢æ¨¡å¼ï¼Œè®°å½•ä»…ä¿å­˜åœ¨æœ¬åœ°æµè§ˆå™¨ä¸­ã€‚<a href="login.html" style="color:#1976d2;text-decoration:underline;font-weight:bold;margin-left:8px;">ç‚¹å‡»ç™»å½•</a>åå¯å°†è®°å½•ç»‘å®šåˆ°æ‚¨çš„è´¦æˆ·ï¼Œå®ç°è·¨è®¾å¤‡åŒæ­¥ã€‚';
                pageTitle.after(loginTip);
            }
            
            // åŠ è½½è®°å½•æ•°æ®
            loadRecords(userInfo);
        });
        
        // åŠ è½½è®°å½•æ•°æ®
        function loadRecords(userInfo) {
            let records = [];
            
            try {
                // ä½¿ç”¨RecordManagerè·å–è®°å½•
                if (window.RecordManager) {
                    records = window.RecordManager.getCurrentUserRecords();
                    console.log('âœ… é€šè¿‡RecordManageråŠ è½½è®°å½•ï¼Œæ•°é‡:', records.length);
                } else {
                    // é™çº§æ–¹æ¡ˆ
                    if (userInfo) {
                        const userRecords = JSON.parse(localStorage.getItem('userRecords') || '[]');
                        records = userRecords.filter(r => r.studentId === userInfo.studentId);
                    } else {
                        records = JSON.parse(localStorage.getItem('guestRecords') || '[]');
                    }
                    console.log('â„¹ï¸ é€šè¿‡localStorageåŠ è½½è®°å½•ï¼ˆé™çº§ï¼‰ï¼Œæ•°é‡:', records.length);
                }
                
                displayRecords(records);
                updateStats(records);
            } catch (error) {
                console.error('âŒ åŠ è½½è®°å½•å¤±è´¥:', error);
            }
        }
        
        // æ˜¾ç¤ºè®°å½•
        function displayRecords(records) {
            const tbody = document.getElementById('records-table-body');
            if (!tbody) return;
            
            tbody.innerHTML = '';
            
            if (records.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align:center;padding:30px;color:#999;">æš‚æ— è®°å½•ï¼Œå¿«å»<a href="calculator.html" style="color:#2e7d32;">è®¡ç®—å™¨</a>åˆ›å»ºç¬¬ä¸€æ¡è®°å½•å§ï¼</td></tr>';
                return;
            }
            
            // æŒ‰æ—¶é—´å€’åºæ’åˆ—
            records.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
            
            records.forEach(record => {
                const row = document.createElement('tr');
                const date = new Date(record.timestamp);
                const dateStr = date.toLocaleString('zh-CN', {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit'
                });
                
                // å°†option1Emissionè½¬æ¢ä¸ºæ•°å­—ç±»å‹
                const option1Emission = parseFloat(record.option1Emission);
                
                row.innerHTML = `
                    <td>${dateStr}</td>
                    <td>${record.studentId || 'è®¿å®¢'}</td>
                    <td>${record.activityType === 'äº¤é€šå‡ºè¡Œ' ? 'äº¤é€š' : 'é£Ÿå“'}</td>
                    <td>${record.option1} (${record.option1Count}${record.activityType === 'äº¤é€šå‡ºè¡Œ' ? 'km' : 'kg'})</td>
                    <td>${record.option2} (${record.option2Count}${record.activityType === 'äº¤é€šå‡ºè¡Œ' ? 'km' : 'kg'})</td>
                    <td>${record.totalEmission.toFixed(3)} kg</td>
                    <td style="color:#2e7d32;font-weight:bold;">${record.savings.toFixed(3)} kg</td>
                `;
                tbody.appendChild(row);
            });
        }
        
        // æ›´æ–°ç»Ÿè®¡æ•°æ®
        function updateStats(records) {
            const totalRecords = records.length;
            const totalEmission = records.reduce((sum, r) => sum + r.totalEmission, 0);
            const avgEmission = totalRecords > 0 ? totalEmission / totalRecords : 0;
            
            document.getElementById('stats-total-records').textContent = totalRecords;
            document.getElementById('stats-total-emission').textContent = totalEmission.toFixed(2) + ' kg';
            document.getElementById('stats-average-emission').textContent = avgEmission.toFixed(2) + ' kg';
        }
    </script>
</head>
<body>
    <header>
        <div class="container">
            <h1>ç¢³è¶³è¿¹è®¡ç®—å™¨</h1>
            <div class="class-info">25-10çŸ¿å¤§èƒ½åŠ¨</div>
        </div>
    </header>

    <nav>
        <div class="container">
            <ul>
                <li><a href="index.html">é¦–é¡µ</a></li>
                <li><a href="calculator.html">ç¢³è¶³è¿¹è®¡ç®—</a></li>
                <li><a href="records.html" class="active">ä¸ªäººè®°å½•</a></li>
                <li><a href="ranking.html">ç­çº§æ’å</a></li>
                <li><a href="login.html" id="register-link">ç™»å½•</a></li>
                <li><a href="#" id="logout-button" style="display:none;">é€€å‡ºç™»å½•</a></li>
                <li><a href="admin.html" class="admin-link">ç®¡ç†å‘˜ç™»å½•</a></li>
            </ul>
        </div>
    </nav>

    <main class="container">
        <h2>ä¸ªäººç¢³è¶³è¿¹è®°å½•</h2>
        <p>æŸ¥çœ‹å’Œåˆ†ææ‚¨çš„ç¢³è¶³è¿¹è®¡ç®—å†å²</p>
        
        <!-- ä¸ªäººç»Ÿè®¡ä¿¡æ¯ -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-number" id="stats-total-records">0</div>
                <div class="stat-label">æ€»è®°å½•æ•°</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="stats-total-emission">0 kg</div>
                <div class="stat-label">æ€»ç¢³æ’æ”¾é‡</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="stats-average-emission">0 kg</div>
                <div class="stat-label">å¹³å‡æ¯æ¬¡æ’æ”¾</div>
            </div>
        </div>
        
        <!-- è®°å½•è¡¨æ ¼ -->
        <div class="records-container">
            <h3>è®¡ç®—è®°å½•</h3>
            <table class="records-table">
                <thead>
            <tr>
                <th>æ—¥æœŸæ—¶é—´</th>
                <th>å­¦å·</th>
                <th>æ´»åŠ¨ç±»å‹</th>
                <th>é€‰é¡¹1</th>
                <th>é€‰é¡¹2</th>
                <th>æ€»æ’æ”¾é‡</th>
                <th>èŠ‚çº¦é‡</th>
            </tr>
        </thead>
                <tbody id="records-table-body">
                    <!-- JavaScript åŠ¨æ€å¡«å…… -->
                </tbody>
            </table>
        </div>
        
        <!-- ç¢³è¶³è¿¹åˆ†æå»ºè®® -->
        <div class="calculator-card" style="margin-top: 30px;">
            <h3>ä¸ªäººç¢³è¶³è¿¹åˆ†æ</h3>
            <p>é€šè¿‡åˆ†ææ‚¨çš„å†å²è®°å½•ï¼Œæˆ‘ä»¬å¯ä»¥ä¸ºæ‚¨æä¾›æ›´ç²¾å‡†çš„ç¢³å‡æ’å»ºè®®ï¼š</p>
            <ul>
                <li>è¯†åˆ«æ‚¨çš„ä¸»è¦ç¢³æ’æ”¾æºï¼Œæœ‰é’ˆå¯¹æ€§åœ°è¿›è¡Œä¼˜åŒ–</li>
                <li>è¿½è¸ªæ‚¨çš„ç¢³å‡æ’è¿›å±•ï¼Œè§è¯ç¯ä¿æˆæœ</li>
                <li>äº†è§£ä¸åŒæ´»åŠ¨çš„ç¢³æ’æ”¾å¼ºåº¦ï¼Œåšå‡ºæ›´ç¯ä¿çš„é€‰æ‹©</li>
            </ul>
            <p>å»ºè®®æ‚¨å®šæœŸè®°å½•å’Œåˆ†æè‡ªå·±çš„ç¢³è¶³è¿¹ï¼ŒæŒç»­æ”¹è¿›ç”Ÿæ´»æ–¹å¼ï¼Œä¸ºç¯ä¿è´¡çŒ®åŠ›é‡ã€‚</p>
        </div>
    </main>

    <footer>
        <div class="container">
            <p>Â© 2023 25-10çŸ¿å¤§èƒ½åŠ¨ - ç¢³è¶³è¿¹è®¡ç®—å™¨</p>
            <p>æœ¬ç½‘ç«™æ—¨åœ¨æé«˜ä½ç¢³ç¯ä¿æ„è¯†ï¼Œä¸ºç¢³å‡æ’è´¡çŒ®åŠ›é‡</p>
        </div>
    </footer>
</body>
</html>